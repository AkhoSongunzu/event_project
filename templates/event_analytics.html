{% extends "base.html" %}
{% block title %}Event Analytics | EMS {% endblock title %}
{% block content %}
<div class="container">

    {% if messages %}
  <div class="messages">
    {% for message in messages %}
      <div class="alert 
        {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" 
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
    </div>
    {%endif%}
    <div class="d-flex justify-content-between align-items-center pt-3 mb-4">
        <!-- Left side (you can add filters, dropdown, title later) -->
        <div>
            <a href="{% url 'organizer_overview' %}" class="btn btn-primary">Overview</a>
            <a href="" class="btn btn-secondary">Manage Events</a>
        </div>

        <!-- Right side: Export PDF button -->
        <div>
            <a href="" class="btn btn-outline-danger">
                <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
            </a>
        </div>
    </div>


    <div class="card p-4 mb-4 bg-success text-white">
        <h4>{{event.title}} Analytics</h4>
        <p>Detailed insights and performance metrics</p>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border rounded-3 p-4 mb-3 shadow-sm">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="h6 text-muted mb-0">Total Views</h6>
                    <!-- Bootstrap + icon -->
                    <i class="bi bi-calender-lg text-muted fs-5"></i>
                </div>

                <div>
                    <p class="h2 fw-bold text-success mb-1">
                        {{total_views}}
                    </p>
                    <p class="text-muted small mb-0">Event page views</p>

                </div>
            </div>

        </div>

        <div class="col-md-3">
            <div class="card border rounded-3 p-4 mb-3 shadow-sm">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="h6 text-muted mb-0">Registrations</h6>
                    <!-- Bootstrap + icon -->
                    <i class="bi bi-calender-lg text-muted fs-5"></i>
                </div>

                <div>
                    <p class="h2 fw-bold text-success mb-1">
                        {{total_registrations}}
                    </p>
                    <p class="text-muted small mb-0">Total attendees</p>

                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border rounded-3 p-4 mb-3 shadow-sm">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="h6 text-muted mb-0">Conversion Rate</h6>
                    <!-- Bootstrap + icon -->
                    <i class="bi bi-calender-lg text-muted fs-5"></i>
                </div>

                <div>
                    <p class="h2 fw-bold text-success mb-1">
                        {{conversion_rate}}%
                    </p>
                    <p class="text-muted small mb-0">Views to registrations</p>

                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 text-center">
                <h6>Upcoming</h6>
                <h3>{{ upcoming_events }}</h3>
                <small>Events this month</small>
            </div>
        </div>
    </div>

    <!-- Quick action -->
    <div class="row g-3">
        <div class="col-md-6">
            <div class="card shadow-sm rounded-3 p-3 mb">
                <div>
                    <h6>Attendee Details</h6>
                    <p class="text-muted">View all the registered pleople</p>
                </div>
                <div class="">

                    {% if registered_users%}
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Last</th>
                                <th scope="col">email</th>
                            </tr>

                        </thead>
                        <tbody>
                            {% for attendee in registered_users %}
                            <tr>
                                <td>{{ attendee.first_name }}</td>
                                <td>{{attendee.last_name}}</td>
                                <td>{{attendee.email}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">No one has registered.</p>
                    {% endif %}
                </div>

            </div>
        </div>

        <div class="col-md-6">
            <div class="bg-white rounded shadow p-3 mb-3">
                {%if total_registrations > 0 %}
                <canvas id="registrationsChart"></canvas>
                {% else %}
                <p class="text-muted">No one has registered yet. Create your first event to see the what we have cooked
                    for
                    you!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- What you can do in your event -->
    <div class="card border rounded-3 p-4 mb-4 shadow-sm mt-4">
        <h4 class="text-danger mb-3">Danger Zone</h4>
        <p class="text-muted">Manage the status of your event. Be careful, these actions cannot be undone easily.</p>

        <!-- Action buttons -->
        <div class="d-flex flex-wrap gap-2 mt-3">
            <!-- Edit Event -->
            <a href="{% url 'edit_event' event.pk %}" class="btn btn-outline-primary">
                <i class="bi bi-pencil-square me-1"></i> Edit Event
            </a>

            <!-- Cancel Event -->
            {% if event.status != 'cancelled' %}
            <form method="post" action="{% url 'cancel_event' event.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger"
                    onclick="return confirm('Are you sure you want to cancel this event?')">
                    <i class="bi bi-x-circle me-1"></i> Cancel Event
                </button>
            </form>
            {% endif %}

            <!-- Publish Event -->
            {% if event.status == 'draft' %}
            <form method="post" action="" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-success">
                    <i class="bi bi-upload me-1"></i> Publish Event
                </button>
            </form>
            {% endif %}
        </div>
    </div>

</div>


<script>
    const ctx = document.getElementById('registrationsChart');

    const data = {
        labels: [
            {% for item in registrations_over_time %}
    "{{ item.date }}",
        {% endfor %}
    ],
    datasets: [{
        label: "Registrations",
        data: [
            {% for item in registrations_over_time %}
          {{ item.count }},
    {% endfor %}
    ],
        fill: false,
            borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
    }]
  };

    new Chart(ctx, {
        type: 'line',
        data: data,
    });
</script>
{% endblock content %}